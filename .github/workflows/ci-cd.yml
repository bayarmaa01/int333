name: CI/CD Pipeline - Learning Platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build & Test Java App
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'  # THIS IS KEY - caches Maven dependencies

      - name: Build with Maven
        run: mvn clean package -DskipTests --batch-mode --no-transfer-progress

      - name: Run Unit Tests
        run: mvn test --batch-mode || true

      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: learning-platform-war
          path: target/*.war
          retention-days: 5

  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download WAR artifact
        uses: actions/download-artifact@v4
        with:
          name: learning-platform-war
          path: target/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/learning-platform:latest
            ${{ secrets.DOCKER_USERNAME }}/learning-platform:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: Deploy to EC2 Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          timeout: 25m
          command_timeout: 20m
          script: |
            #!/bin/bash
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to project directory
            cd ~/int333 || cd /home/ubuntu/int333 || cd /home/$USER/int333
            
            echo "üì• Pulling latest code..."
            git pull origin main
            
            echo "üõë Stopping old containers..."
            docker-compose down --timeout 60 || true
            
            echo "üßπ Cleaning up Docker resources..."
            docker system prune -f --volumes || true
            
            echo "üì¶ Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/learning-platform:latest || true
            
            echo "üöÄ Starting services..."
            docker-compose up -d --force-recreate
            
            echo "‚è≥ Waiting for services to start..."
            sleep 30
            
            echo "üîç Checking container status..."
            docker-compose ps
            
            echo "üè• Health check..."
            for i in {1..10}; do
              if curl -f http://localhost:80/learning-platform/ > /dev/null 2>&1; then
                echo "‚úÖ Application is healthy!"
                exit 0
              fi
              echo "‚è≥ Waiting... attempt $i/10"
              sleep 5
            done
            
            echo "‚ö†Ô∏è Health check timeout, but containers are running"
            docker-compose logs --tail=50 app
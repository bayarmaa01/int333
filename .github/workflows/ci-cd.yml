name: CI/CD Pipeline - Learning Platform

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    name: Build & Test Java App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests --batch-mode

      - name: Run unit tests
        run: mvn test --batch-mode || true

      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: learning-platform-war
          path: target/*.war

  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download WAR artifact
        uses: actions/download-artifact@v4
        with:
          name: learning-platform-war
          path: target/

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/learning-platform:latest
            ${{ secrets.DOCKER_USERNAME }}/learning-platform:${{ github.sha }}

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "üöÄ Deployment started"

            cd ~/int333 || cd /home/ubuntu/int333

            echo "üì• Git pull"
            git pull origin main

            echo "üõë Stopping old containers"
            docker compose down || true

            echo "üì¶ Pulling latest Docker image"
            docker pull ${{ secrets.DOCKER_USERNAME }}/learning-platform:latest

            echo "üöÄ Starting new containers"
            docker compose up -d --force-recreate

            echo "üîç Checking app health"
            for i in {1..10}; do
              if curl -f http://localhost:80/learning-platform/ >/dev/null 2>&1; then
                echo "‚úÖ App is healthy"
                exit 0
              fi
              echo "‚è≥ Retry $i/10..."
              sleep 5
            done

            echo "‚ö†Ô∏è App is running but health check failed"
